{% extends "base.html" %}

{% block import %}
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<link rel="stylesheet" href="/static/css/wallet.css">
{% endblock %}

{% block content %}
<div class="container">

    <div id="overlay" class="overlay"></div>

    <header class="header-container">
        <p>Interface: <span style="color: #0088cd">{{wallet_data['interface']}}</span></p>
        <div class="get-phrase" id="open-bottom-sheet-seed-phrase">
            <p>Seed Phrase</p>
        </div>
    </header>
    <hr>
    <div class="balance-container">
        <p>{{wallet_data['balance']}} $</p>
        <span>{{wallet_data['shorten_address']}}</span>
    </div>
    <div class="utility-container">
        <div class="item" id="open-bottom-sheet-receive">
            <img height="auto" width="45" src="/static/img/Inbox.png">
            <span>Receive</span>
        </div>
        <div class="item" id="open-bottom-sheet-send">
            <img height="auto" width="45" src="/static/img/Outbox.png">
            <span>Send</span>
        </div>
    </div>
    <hr>
    <div class="assets-container">
<!--        <p style="font-size: 1.2rem; color: #7d7d7d;">Assets</p>-->


        {% for asset in wallet_data['assets'].values() %}

        <div class="card">
            <div class="icon">
                <img src="/static/img/Toncoin.png">
            </div>
            <div class="content">
                <div class="title">{{ asset['name'] }}</div>
                <div class="subtitle"> {{ asset['value'] }} {{ asset['symbol'] }}</div>
            </div>
            <div class="price">{{ asset['price'] }} $</div>
        </div>
        {% endfor %}
    </div>
    <hr>
    <footer>
        <div class="card">
            <div class="icon">
                <img src="/static/img/Folder.png">
            </div>
            <div class="content">
                <div class="history">Transactions History</div>
            </div>
            <div class="arrow">â€º</div>
        </div>
    </footer>

    <div id="bottom-sheet-receive" class="bottom-sheet">
        <span class="close">&times;</span>
        <div class="bottom-sheet-content">
            <img height="auto" width="130" src="/static/img/Inbox.png" alt="Inbox">
            <h1>Receive Toncoin</h1>
            <p>Use this address to receive Toncoin or <span style="color: #0088cd">TON</span> network tokens, otherwise you may lose your funds.</p>
            <div id="address-container">
                {{wallet_data['address']}}
            </div>
            <div class="button-container">
                <button class="copy-address-button" onclick="copyToClipboardAddress()" data-address="{{wallet_data['address']}}">Copy Address</button>
            </div>
        </div>
    </div>

    <div id="bottom-sheet-send" class="bottom-sheet">
        <span class="close">&times;</span>
        <div class="bottom-sheet-content">
            <img height="auto" width="130" src="/static/img/Outbox.png" alt="Inbox">
            <h1>Send Toncoin</h1>
            <p>Please fill in the required fields.</p>

            <form id="send-form">
                <input type="text" name="amount" placeholder="Amount">
                <input type="text" name="address" placeholder="Address">
                <input type="text" name="memo" placeholder="Memo (Optional)">
                <div class="form-button-container">
                    <button type="submit" class="submit-button">Confirm</button>
                    <button type="reset" class="reset-button">Clear</button>
                </div>
            </form>

            <div class="indent-for-keyboard"></div>

        </div>
    </div>

    <div id="bottom-sheet-seed-phrase" class="bottom-sheet">
        <span class="close">&times;</span>
        <div class="bottom-sheet-content">
            <img height="auto" width="130" src="/static/img/Key.png" alt="Inbox">
            <h1>Seed phrase</h1>
            <p>Do not share your Seed Phrase with anyone, it is needed to access your wallet.</p>

            <div class="mnemonic-container">
                <ol class="column">
                    {% for i in range(0, 12) %}
                    <li>{{ wallet_data['mnemonics'][i] }}</li>
                    {% endfor %}
                </ol>
                <ol class="column" start="13">
                    {% for i in range(12, 24) %}
                    <li>{{ wallet_data['mnemonics'][i] }}</li>
                    {% endfor %}
                </ol>
            </div>

            <div class="button-container">
                <button class="copy-seed-phrase-button" onclick="copyToClipboardSeedPhrase()" data-phrase="{{ wallet_data['mnemonics'] | join(' ') }}">Copy Phrase</button>
            </div>
        </div>
    </div>

    <div id="transaction-status" class="bottom-sheet">
        <span class="close">&times;</span>
        <div class="bottom-sheet-content">
            <p id="transaction-status-message">Processing Transaction...</p>
        </div>
    </div>


    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const tg = window.Telegram.WebApp;

            const sendForm = document.getElementById('send-form');
            const inputs = sendForm.querySelectorAll('input');
            const indentForKeyboard = document.querySelector('.indent-for-keyboard');

            const bottomSheetSend = document.getElementById('bottom-sheet-send');
            const transactionStatus = document.getElementById('transaction-status');
            const transactionStatusMessage = document.getElementById('transaction-status-message');
            const overlay = document.getElementById('overlay');
            const closeBtns = document.querySelectorAll('.close');

            const openBtnReceive = document.getElementById('open-bottom-sheet-receive');
            const openBtnSend = document.getElementById('open-bottom-sheet-send');
            const openBtnSeedPhrase = document.getElementById('open-bottom-sheet-seed-phrase');

            const bottomSheetReceive = document.getElementById('bottom-sheet-receive');
            const bottomSheetSeedPhrase = document.getElementById('bottom-sheet-seed-phrase');


            function handleKeyboardShow() {
                const keyboardHeight = tg.viewportHeight - tg.viewportStableHeight;
                indentForKeyboard.style.paddingBottom = `${keyboardHeight}px`;
            }

            function handleKeyboardHide() {
                indentForKeyboard.style.paddingBottom = '0';
            }

            inputs.forEach(input => {
                input.addEventListener('focus', handleKeyboardShow);
                input.addEventListener('blur', handleKeyboardHide);
            });

            window.addEventListener('resize', function() {
                if (window.innerHeight < document.documentElement.clientHeight) {
                    handleKeyboardShow();
                } else {
                    handleKeyboardHide();
                }
            });
            
            function closeModal(modal) {
                modal.classList.add('hide');
                setTimeout(() => {
                    modal.classList.remove('show');
                    modal.classList.remove('hide');
                    overlay.style.display = 'none';
                }, 500);
            }

            openBtnReceive.addEventListener('click', function() {
                bottomSheetReceive.classList.add('show');
                overlay.style.display = 'block';
            });

            openBtnSend.addEventListener('click', function() {
                bottomSheetSend.classList.add('show');
                overlay.style.display = 'block';
            });

            openBtnSeedPhrase.addEventListener('click', function() {
                bottomSheetSeedPhrase.classList.add('show');
                overlay.style.display = 'block';
            });

            closeBtns.forEach(btn => {
                btn.addEventListener('click', function() {
                    if (btn.closest('.bottom-sheet')) {
                        closeModal(btn.closest('.bottom-sheet'));
                    }
                });
            });

            window.addEventListener('click', function(event) {
                if (event.target === overlay) {
                    closeModal(bottomSheetReceive);
                    closeModal(bottomSheetSend);
                    closeModal(bottomSheetSeedPhrase);
                    closeModal(transactionStatus);
                }
            });

            function clearBorders() {
                inputs.forEach(input => {
                    input.style.border = '2px solid transparent';
                });
            }


            sendForm.addEventListener('submit', function(event) {
                event.preventDefault();

                const amount = parseFloat(sendForm.elements['amount'].value);
                const address = sendForm.elements['address'].value.trim();
                const memo = sendForm.elements['memo'].value.trim();

                let isValid = true;
                if (isNaN(amount) || amount <= 0) {
                    sendForm.elements['amount'].style.border = '2px solid #dc3545';
                    isValid = false;
                } else {
                    sendForm.elements['amount'].style.border = '2px solid seagreen';
                }
                if (address.length <= 20 || /\s/.test(address)) {
                    sendForm.elements['address'].style.border = '2px solid #dc3545';
                    isValid = false;
                } else {
                    sendForm.elements['address'].style.border = '2px solid seagreen';
                }

                if (!isValid) {
                    return;
                }

                closeModal(bottomSheetSend);

                sendForm.reset();
                clearBorders();

                transactionStatusMessage.innerText = 'Processing Transaction...';
                transactionStatus.classList.add('show');
                overlay.style.display = 'block';

                setTimeout(() => {
                    transactionStatusMessage.innerText = 'Transaction Successful!';
                    setTimeout(() => {
                        closeModal(transactionStatus);
                    }, 3000);
                }, 2000);
            });
        });

        function copyToClipboardSeedPhrase() {
            const button = document.querySelector('.copy-seed-phrase-button');
            const textToCopy = button.getAttribute('data-phrase');

            navigator.clipboard.writeText(textToCopy)
                .then(() => {
                    button.innerText = 'Copied';
                    button.style.border = '2px solid seagreen';
                })
                .catch(err => {
                    console.error('Could not copy seed-phrase: ', err);
                });
        }

        function copyToClipboardAddress() {
            const button = document.querySelector('.copy-address-button');
            const addressToCopy = button.getAttribute('data-address');

            navigator.clipboard.writeText(addressToCopy)
                .then(() => {
                    button.innerText = 'Copied';
                    button.style.border = '2px solid seagreen';
                })
                .catch(err => {
                    console.error('Could not copy seed-phrase: ', err);
                });
        }
    </script>
</div>
{% endblock %}